class FetchFactory{static async fetchNewSource(e){return await fetch(`${e}api/new.php`).then(e=>e.json()).then(e=>Object.entries(e)).catch(e=>console.error("Failed to fetch new sources :",e.message))}static async fetchSources(e,t){return await fetch(`${e}api/sources.php?isNsfw=${t}`).then(e=>e.json()).then(e=>{if(Object.entries(e).length>0)return Object.entries(e);throw new Exception("No folder available !")}).catch(e=>console.error("Failed to fetch sources :",e.message))}static async fetchLast(e,t=!1,a=!1){return await fetch(`${e}api/last.php?isNsfw=${t}&folder=${a}`).then(e=>e.json()).then(e=>{if(e.length>24)return Array.from(e).slice(0,24);if(e.length>0)return Array.from(e);throw new Exception("No recent addition!")})}static async fetchFolders(e,t){return await fetch(`${e}api/folders.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({source:t})}).then(e=>e.json()).then(e=>Object.entries(e).length>0?Object.entries(e):[]).catch(e=>console.error("Failed to fetch folders :",e.message))}static async fetchThumbnails(e,t){return await fetch(`${e}api/thumbnails.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({source:t})}).then(e=>e.json()).then(e=>Object.entries(e).length>0?Object.entries(e):[]).catch(e=>console.error("Failed to fetch folders :",e.message))}}class ElementFactory{static createHeader(){const e=document.createElement("header");return e.appendChild(this.createNavbar()),e}static createSpinner(){const e=document.createElement("div");e.id="spinnerLoad",e.className="loading-text",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.innerHTML="Loading<div id='progressMore'></div>";const t=document.createElement("div");t.id="spinnerNumber",t.className="loading-text",t.setAttribute("aria-live","polite");const a=document.createElement("div");return a.id="spinner",a.className=a.id+" loading",a.appendChild(e),a.appendChild(t),a}static createNavbar(){const e=document.createElement("nav");e.classList="navbar",e.ariaRoleDescription="Navigation bar";const t=document.createElement("h2");t.innerText="Gposes Xplorer",e.appendChild(t);const a=document.createElement("ul");a.innerHTML='<li title="Index"><span class="material-symbols-outlined">home</span></li><li title="Back"><span class="material-symbols-outlined">subdirectory_arrow_left</span></li>',e.appendChild(a);const n=document.createElement("ul");return n.innerHTML="<li><input type='radio' id='isNsfwFalse' name='isNSFW' value='false'><label for='isNsfwFalse'>SFW</label></li><li><input type='radio' id='isNsfwTrue' name='isNSFW' value='true'><label for='isNsfwTrue'>NSFW</label></li>",e.appendChild(n),e}static createRepository(){const e=document.createElement("div");return e.classList="repository",e}static createSourceFolder(e="",t="",a=""){const n=document.createElement("div");n.dataset.title=e,n.dataset.link=t,n.className="card",n.title=`Open the "${e}" folder`;const s=document.createElement("div");s.classList="img-div",n.append(s);const i=document.createElement("img");i.src=a,"./assets/img/folder.png"===a&&(i.classList="folder"),i.alt=a.split("/").pop(),s.appendChild(i),i.onload=function(){i.naturalHeight<250&&(i.classList="fullheight",s.style.display="flex",s.style.justifyContent="center")};const o=document.createElement("div");return o.classList="overlay",s.appendChild(o),n}static createPicture(e="",t="",a=""){const n=document.createElement("div");n.dataset.title=t.split("/").pop(),n.className="card",n.title=`Show the "${n.dataset.title}" picture`;const s=document.createElement("a");s.classList="img-div",s.href=t.replace("../",e),s.target="_blank",n.append(s);const i=document.createElement("img");return i.src=a.replace("../",e),i.loading="lazy",i.alt=a.split("/").pop(),s.appendChild(i),i.onload=function(){i.naturalHeight<250&&(i.classList="fullheight",s.style.display="flex",s.style.justifyContent="center")},n}static createDownloadButton(e="",t=""){const a=document.createElement("div");a.classList="download",a.title="Download pictures as zip file";const n=document.createElement("a");return n.innerHTML='<span class="material-symbols-outlined">folder_zip</span>',n.href=`${e}api/zip.php?folder=${encodeURI(t)}`,a.appendChild(n),console.log("https://naslku.synology.me/gposesXplorerAPI/api/zip.php?folder=Trivia%2F1.SFW"),console.log(n.href),a}static createSeparation(){const e=document.createElement("hr");return e.classList="separator",e}static updateCarouselButton(){const e=600,t=document.querySelector(".carousel-container");t.scrollLeft-(t.scrollWidth-t.clientWidth)>-600&&!document.querySelector(".btnRight").classList.contains("hidden")?document.querySelector(".btnRight").classList.add("hidden"):t.scrollLeft-(t.scrollWidth-t.clientWidth)<-600&&document.querySelector(".btnRight").classList.remove("hidden"),t.scrollLeft<e&&!document.querySelector(".btnLeft").classList.contains("hidden")?document.querySelector(".btnLeft").classList.add("hidden"):t.scrollLeft>e&&document.querySelector(".btnLeft").classList.remove("hidden")}static scrollCarousel(e){const t=document.querySelector(".carousel-container"),a=t.offsetWidth;t.scrollBy({left:e*a,behavior:"smooth"}),setTimeout(()=>{this.updateCarouselButton()},500)}static createCarousel(){const e=document.createElement("div");e.classList="carousel";const t=document.createElement("div");t.classList="carousel-container",e.appendChild(t);const a=document.createElement("div");a.classList="carousel-tracker",t.appendChild(a);const n=document.createElement("button");n.innerHTML='<span class="material-symbols-outlined">arrow_back</span>',n.classList="btn btnLeft",n.title="Nextly added",n.addEventListener("click",()=>{this.scrollCarousel(-1)}),e.appendChild(n);const s=document.createElement("button");return s.innerHTML='<span class="material-symbols-outlined">arrow_forward</span>',s.classList="btn btnRight",s.title="Previously added",s.addEventListener("click",()=>{this.scrollCarousel(1)}),e.appendChild(s),e}static createRecentCarousel(e,t=[]){const a=this.createCarousel();return Array.from(t).forEach(t=>{const n=`${t.folder}/${t.name}`,s="./assets/img/folder.png"!==t.preview?encodeURI(`${e}${t.preview}`):"./assets/img/folder.png";a.firstChild.firstChild.appendChild(this.createSourceFolder(t.name,n,s))}),a}}class Utilities{static isNsfw=!1;static setIsNsfw(){const e=new URLSearchParams(window.location.search);this.isNsfw=this.isWelcomePage()&&"true"===e.get("isNsfw")}static get WELCOME_TITLE(){return"Welcome | Gposes Xplorer"}static isWelcomePage(){return document.title===this.WELCOME_TITLE}static setDocumentTitle(e=""){document.title=e}static getLinkTitle(e=""){let t="";return null!==e&&(t="1.SFW"===e.split("/").pop()||"2.NSFW"===e.split("/").pop()?e.split("/")[0]:e.split("/").pop()),t}static getFolder(){const e=new URLSearchParams(window.location.search).get("folder");return[this.getLinkTitle(e),e]}static loadContent(e=""){this.setIsNsfw();const t=this.getFolder();if(null!==t[1])document.querySelector("header ul:nth-child(3)").style.visibility="hidden",document.querySelector("header ul:nth-child(2)").style.visibility="visible",t[1].split("/").pop()===t[0]&&t[1].split("/").length>1?document.querySelector("header ul:nth-child(2) li:nth-child(2)").style.display="block":document.querySelector("header ul:nth-child(2) li:nth-child(2)").style.display="none",this.setDocumentTitle(`${t[0]} | Gposes Xplorer`),this.loadFolder(e,t[1]);else{const t=new URLSearchParams(window.location.search);document.querySelector(`header ul input[name='isNSFW'][value='${this.isNsfw}']`).checked=!0,document.querySelector("header ul:nth-child(3)").style.visibility=null===t.get("isNsfw")?"hidden":"visible",document.querySelector("header ul:nth-child(2)").style.visibility="hidden",this.setDocumentTitle(this.WELCOME_TITLE),this.loadSources(e)}}static async loadSources(e=""){const t=document.querySelector(".repository");t.innerHTML="<span></span>";const a=ElementFactory.createSpinner();document.body.appendChild(a),t.innerHTML+="<h3>Last addition</h3>",await FetchFactory.fetchLast(e,this.isNsfw,!0).then(a=>{const n=ElementFactory.createRecentCarousel(e,a);t.appendChild(n),Array.from(n.querySelectorAll(".card")).forEach((e,t)=>{e.addEventListener("click",()=>{this.goToFolder(e.dataset.link)})}),t.appendChild(ElementFactory.createSeparation())}).catch(e=>console.error(e.message));const n=document.createElement("h3");n.innerHTML="Sources",t.appendChild(n);const s=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});await FetchFactory.fetchSources(e,this.isNsfw).then(a=>{a.sort((e,t)=>s.compare(e[0],t[0])),a.forEach(a=>{let n=a[1];"../assets/img/folder.png"!==a[1]&&(n=a[1].replace("../",e));const s=ElementFactory.createSourceFolder(this.getLinkTitle(a[0]),a[0],n);s.addEventListener("click",()=>{this.goToFolder(a[0])}),t.appendChild(s)});const n=Math.max(...this.itemsPerFlexRow(t));Array.from(document.querySelectorAll(".carousel .card")).forEach(e=>{e.style=`--max-items: ${n}`}),ElementFactory.updateCarouselButton()}),a.remove()}static async loadFolder(e="",t=""){const a=document.querySelector(".repository");a.innerHTML="";const n=ElementFactory.createSpinner();document.body.appendChild(n);const s=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});await FetchFactory.fetchFolders(e,t).then(n=>{n.sort((e,t)=>s.compare(e[0],t[0])).forEach(n=>{let s=n[1];"../assets/img/folder.png"!==n[1]&&(s=n[1].replace("../",e));const i=ElementFactory.createSourceFolder(this.getLinkTitle(n[0]),t+"/"+n[0],s);i.addEventListener("click",()=>{this.goToFolder(t+"/"+n[0])}),a.appendChild(i)}),n.length>0&&a.appendChild(ElementFactory.createSeparation())}),await FetchFactory.fetchThumbnails(e,t).then(t=>{t.sort((e,t)=>s.compare(e[1][0],t[1][0])).forEach(t=>{a.appendChild(ElementFactory.createPicture(e,t[1][0].replace("../",e),t[1][1].replace("../",e)))}),0===t.length&&a.querySelector(".separator").remove()}),n.remove(),a.appendChild(ElementFactory.createDownloadButton(e,t))}static initMainParts(e=""){FetchFactory.fetchNewSource(e).then(e=>{e.length>0&&console.warn("New sources added: ",e.concat(", "))});const t=ElementFactory.createHeader();document.body.appendChild(t),t.querySelector("ul:nth-child(2) li").addEventListener("click",()=>{this.returnIndex()}),t.querySelector("ul:nth-child(2) li:nth-child(2)").addEventListener("click",()=>{this.goBack()}),Array.from(document.querySelectorAll("header ul:nth-child(3) li label")).forEach(e=>{e.addEventListener("click",e=>{this.changeNsfwPart(e.currentTarget.previousElementSibling.value)})}),document.body.appendChild(ElementFactory.createRepository())}static goToFolder(e){const t=this.getLinkTitle(e),a=new URLSearchParams(window.location.search);a.set("folder",e);const n=`${document.location.pathname}`+(""===a.toString()?"":"?")+`${a.toString()}`;history.pushState({data:"optional state object"},t,n),this.setDocumentTitle(t)}static goBack(){const e=new URLSearchParams(window.location.search).get("folder");this.goToFolder(e.split("/").slice(0,-1).join("/")),setTimeout(()=>{document.querySelector(`[data-link="${e}"]`).scrollIntoView({behavior:"smooth",block:"nearest"}),scrollY(0)},500)}static returnIndex(){const e=this.WELCOME_TITLE,t=new URLSearchParams(window.location.search);t.delete("folder");const a=`${document.location.pathname}`+(""===t.toString()?"":"?")+`${t.toString()}`;history.pushState({data:"optional state object"},e,a),this.setDocumentTitle(e)}static changeNsfwPart(e){const t=new URLSearchParams(window.location.search);t.set("isNsfw",e);const a=this.WELCOME_TITLE,n=`${document.location.pathname}`+(""===t.toString()?"":"?")+`${t.toString()}`;history.pushState({data:"optional state object"},a,n),this.setDocumentTitle(a)}static itemsPerFlexRow(e){const t=Array.from(e.children),a={};return t.forEach(e=>{const t=e.offsetTop;a[t]||(a[t]=[]),a[t].push(e)}),Object.values(a).map(e=>e.length)}}const host="https://naslku.synology.me/gposesXplorerAPI/";async function handleInitialLoad(){Utilities.setIsNsfw(),Utilities.initMainParts(host),addNavigateSuccess(()=>Utilities.loadContent(host)),Utilities.loadContent(host)}function addNavigateSuccess(e){window.navigation?(window.navigation.removeEventListener("navigatesuccess",e),window.navigation.addEventListener("navigatesuccess",e)):(window._navigationFallback||(Object.defineProperty(window,"_navigationFallback",{value:{handlers:new Set,setup(){if(history.pushState._isMonkeyPatched)return;const e=history.pushState;history.pushState=function(...t){e.apply(this,t),window.document.title=t[1],window.dispatchEvent(new CustomEvent("fallbacknavigate",{detail:{url:window.location.href,state:t[0]}}))},history.pushState._isMonkeyPatched=!0,history.replaceState=function(...t){e.apply(this,t),window.document.title=t[1],window.dispatchEvent(new CustomEvent("fallbacknavigate",{detail:{url:window.location.href,state:t[0]}}))},history.replaceState._isMonkeyPatched=!0;const t=()=>{const e={destination:{url:window.location.href},state:history.state};window._navigationFallback.handlers.forEach(t=>t(e))};window.addEventListener("popstate",t),window.addEventListener("hashchange",t),window.addEventListener("fallbacknavigate",t)}},writable:!1,configurable:!1}),window._navigationFallback.setup()),window._navigationFallback.handlers.delete(e),window._navigationFallback.handlers.add(e))}document.addEventListener("DOMContentLoaded",()=>{handleInitialLoad()});