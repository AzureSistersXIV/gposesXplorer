class FetchFactory{static async fetchNewSource(e){return await fetch(`${e}api/new.php`).then(e=>e.json()).then(e=>Object.entries(e)).catch(e=>console.error("Failed to fetch new sources :",e.message))}static async fetchSources(e,t){return await fetch(`${e}api/sources.php?isNsfw=${t}`).then(e=>e.json()).then(e=>{if(Object.entries(e).length>0)return Object.entries(e);throw new Exception("No folder available !")}).catch(e=>console.error("Failed to fetch sources :",e.message))}static async fetchLast(e,t=!1,n=!1){return await fetch(`${e}api/last.php?isNsfw=${t}&folder=${n}`).then(e=>e.json()).then(e=>{if(e.length>24)return Array.from(e).slice(0,24);if(e.length>0)return Array.from(e);throw new Exception("No recent addition!")})}static async fetchFolders(e,t){return await fetch(`${e}api/folders.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({source:t})}).then(e=>e.json()).then(e=>Object.entries(e).length>0?Object.entries(e):[]).catch(e=>console.error("Failed to fetch folders :",e.message))}static async fetchThumbnails(e,t){return await fetch(`${e}api/thumbnails.php`,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams({source:t})}).then(e=>e.json()).then(e=>Object.entries(e).length>0?Object.entries(e):[]).catch(e=>console.error("Failed to fetch folders :",e.message))}}class ElementFactory{static createHeader(){const e=document.createElement("header");return e.appendChild(this.createNavbar()),e}static createSpinner(){const e=document.createElement("div");e.id="spinnerLoad",e.className="loading-text",e.setAttribute("role","status"),e.setAttribute("aria-live","polite"),e.innerHTML="Loading<div id='progressMore'></div>";const t=document.createElement("div");t.id="spinnerNumber",t.className="loading-text",t.setAttribute("aria-live","polite");const n=document.createElement("div");return n.id="spinner",n.className=n.id+" loading",n.appendChild(e),n.appendChild(t),n}static createNavbar(){const e=document.createElement("nav");e.classList="navbar",e.ariaRoleDescription="Navigation bar";const t=document.createElement("h2");t.innerText="Gposes Xplorer",e.appendChild(t);const n=document.createElement("ul");n.innerHTML="<li>Index</li><li>Back</li>",e.appendChild(n);const a=document.createElement("ul");return a.innerHTML="<li><input type='radio' id='isNsfwFalse' name='isNSFW' value='false'><label for='isNsfwFalse'>SFW</label></li><li><input type='radio' id='isNsfwTrue' name='isNSFW' value='true'><label for='isNsfwTrue'>NSFW</label></li>",e.appendChild(a),e}static createRepository(){const e=document.createElement("div");return e.classList="repository",e}static createSourceFolder(e="",t="",n=""){const a=document.createElement("div");a.dataset.title=e,a.dataset.link=t,a.className="card";const s=document.createElement("div");s.classList="img-div",a.append(s);const i=document.createElement("img");i.src=n,"./assets/img/folder.png"===n&&(i.classList="folder"),i.alt=n.split("/").pop(),s.appendChild(i),i.onload=function(){i.naturalHeight<250&&(i.classList="fullheight",s.style.display="flex",s.style.justifyContent="center")};const o=document.createElement("div");return o.classList="overlay",s.appendChild(o),a}static createPicture(e="",t="",n=""){const a=document.createElement("div");a.dataset.title=t.split("/").pop(),a.className="card";const s=document.createElement("a");s.classList="img-div",s.href=t.replace("../",e),s.target="_blank",a.append(s);const i=document.createElement("img");return i.src=n.replace("../",e),i.loading="lazy",i.alt=n.split("/").pop(),s.appendChild(i),i.onload=function(){i.naturalHeight<250&&(i.classList="fullheight",s.style.display="flex",s.style.justifyContent="center")},a}static createSeparation(){const e=document.createElement("hr");return e.classList="separator",e}static updateCarouselButton(){const e=600,t=document.querySelector(".carousel-container");t.scrollLeft-(t.scrollWidth-t.clientWidth)>-600&&!document.querySelector(".btnRight").classList.contains("hidden")?document.querySelector(".btnRight").classList.add("hidden"):t.scrollLeft-(t.scrollWidth-t.clientWidth)<-600&&document.querySelector(".btnRight").classList.remove("hidden"),t.scrollLeft<e&&!document.querySelector(".btnLeft").classList.contains("hidden")?document.querySelector(".btnLeft").classList.add("hidden"):t.scrollLeft>e&&document.querySelector(".btnLeft").classList.remove("hidden")}static scrollCarousel(e){const t=document.querySelector(".carousel-container"),n=t.offsetWidth;t.scrollBy({left:e*n,behavior:"smooth"}),setTimeout(()=>{this.updateCarouselButton()},500)}static createCarousel(){const e=document.createElement("div");e.classList="carousel";const t=document.createElement("div");t.classList="carousel-container",e.appendChild(t);const n=document.createElement("div");n.classList="carousel-tracker",t.appendChild(n);const a=document.createElement("button");a.innerHTML="←",a.classList="btn btnLeft",a.addEventListener("click",()=>{this.scrollCarousel(-1)}),e.appendChild(a);const s=document.createElement("button");return s.innerHTML="→",s.classList="btn btnRight",s.addEventListener("click",()=>{this.scrollCarousel(1)}),e.appendChild(s),e}static createRecentCarousel(e,t=[]){const n=this.createCarousel();return Array.from(t).forEach(t=>{const a=`${t.folder}/${t.name}`,s="./assets/img/folder.png"!==t.preview?encodeURI(`${e}${t.preview}`):"./assets/img/folder.png";n.firstChild.firstChild.appendChild(this.createSourceFolder(t.name,a,s))}),n}}class Utilities{static isNsfw=!1;static setIsNsfw(){const e=new URLSearchParams(window.location.search);this.isNsfw=this.isWelcomePage()&&"true"===e.get("isNsfw")}static get WELCOME_TITLE(){return"Welcome | Gposes Xplorer"}static isWelcomePage(){return document.title===this.WELCOME_TITLE}static setDocumentTitle(e=""){document.title=e}static getLinkTitle(e=""){let t="";return null!==e&&(t="1.SFW"===e.split("/").pop()||"2.NSFW"===e.split("/").pop()?e.split("/")[0]:e.split("/").pop()),t}static getFolder(){const e=new URLSearchParams(window.location.search).get("folder");return[this.getLinkTitle(e),e]}static loadContent(e=""){this.setIsNsfw();const t=this.getFolder();if(null!==t[1])document.querySelector("header ul:nth-child(3)").style.visibility="hidden",document.querySelector("header ul:nth-child(2)").style.visibility="visible",t[1].split("/").pop()===t[0]&&t[1].split("/").length>1?document.querySelector("header ul:nth-child(2) li:nth-child(2)").style.display="block":document.querySelector("header ul:nth-child(2) li:nth-child(2)").style.display="none",this.setDocumentTitle(`${t[0]} | Gposes Xplorer`),this.loadFolder(e,t[1]);else{const t=new URLSearchParams(window.location.search);document.querySelector(`header ul input[name='isNSFW'][value='${this.isNsfw}']`).checked=!0,document.querySelector("header ul:nth-child(3)").style.visibility=null===t.get("isNsfw")?"hidden":"visible",document.querySelector("header ul:nth-child(2)").style.visibility="hidden",this.setDocumentTitle(this.WELCOME_TITLE),this.loadSources(e)}}static async loadSources(e=""){const t=document.querySelector(".repository");t.innerHTML="<span></span>";const n=ElementFactory.createSpinner();document.body.appendChild(n),t.innerHTML+="<h3>Last addition</h3>",await FetchFactory.fetchLast(e,this.isNsfw,!0).then(n=>{const a=ElementFactory.createRecentCarousel(e,n);t.appendChild(a),Array.from(a.querySelectorAll(".card")).forEach((e,t)=>{e.addEventListener("click",()=>{this.goToFolder(e.dataset.link)})}),t.appendChild(ElementFactory.createSeparation())}).catch(e=>console.error(e.message)),t.innerHTML+="<h3>Sources</h3>";const a=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});await FetchFactory.fetchSources(e,this.isNsfw).then(n=>{n.sort((e,t)=>a.compare(e[0],t[0])),n.forEach(n=>{let a=n[1];"../assets/img/folder.png"!==n[1]&&(a=n[1].replace("../",e));const s=ElementFactory.createSourceFolder(this.getLinkTitle(n[0]),n[0],a);s.addEventListener("click",()=>{this.goToFolder(n[0])}),t.appendChild(s)});const s=Math.max(...this.itemsPerFlexRow(t));Array.from(document.querySelectorAll(".carousel .card")).forEach(e=>{e.style=`--max-items: ${s}`}),ElementFactory.updateCarouselButton()}),n.remove()}static async loadFolder(e="",t=""){const n=document.querySelector(".repository");n.innerHTML="";const a=ElementFactory.createSpinner();document.body.appendChild(a);const s=new Intl.Collator("en",{numeric:!0,sensitivity:"base"});await FetchFactory.fetchFolders(e,t).then(a=>{a.sort((e,t)=>s.compare(e[0],t[0])).forEach(a=>{let s=a[1];"../assets/img/folder.png"!==a[1]&&(s=a[1].replace("../",e));const i=ElementFactory.createSourceFolder(this.getLinkTitle(a[0]),t+"/"+a[0],s);i.addEventListener("click",()=>{this.goToFolder(t+"/"+a[0])}),n.appendChild(i)}),a.length>0&&n.appendChild(ElementFactory.createSeparation())}),await FetchFactory.fetchThumbnails(e,t).then(t=>{t.sort((e,t)=>s.compare(e[1][0],t[1][0])).forEach(t=>{n.appendChild(ElementFactory.createPicture(e,t[1][0].replace("../",e),t[1][1].replace("../",e)))}),0===t.length&&n.querySelector(".separator").remove()}),a.remove()}static initMainParts(e=""){FetchFactory.fetchNewSource(e).then(e=>{e.length>0&&console.warn("New sources added: ",e.concat(", "))});const t=ElementFactory.createHeader();document.body.appendChild(t),t.querySelector("ul:nth-child(2) li").addEventListener("click",()=>{this.returnIndex()}),t.querySelector("ul:nth-child(2) li:nth-child(2)").addEventListener("click",()=>{this.goBack()}),Array.from(document.querySelectorAll("header ul:nth-child(3) li label")).forEach(e=>{e.addEventListener("click",e=>{this.changeNsfwPart(e.currentTarget.previousElementSibling.value)})}),document.body.appendChild(ElementFactory.createRepository())}static goToFolder(e){const t=this.getLinkTitle(e),n=new URLSearchParams(window.location.search);n.set("folder",e);const a=`${document.location.pathname}`+(""===n.toString()?"":"?")+`${n.toString()}`;history.pushState({data:"optional state object"},t,a),this.setDocumentTitle(t)}static goBack(){const e=new URLSearchParams(window.location.search).get("folder");this.goToFolder(e.split("/").slice(0,-1).join("/")),setTimeout(()=>document.querySelector(`[data-link="${e}"]`).scrollIntoView({behavior:"smooth",block:"nearest"}),500)}static returnIndex(){const e=this.WELCOME_TITLE,t=new URLSearchParams(window.location.search);t.delete("folder");const n=`${document.location.pathname}`+(""===t.toString()?"":"?")+`${t.toString()}`;history.pushState({data:"optional state object"},e,n),this.setDocumentTitle(e)}static changeNsfwPart(e){const t=new URLSearchParams(window.location.search);t.set("isNsfw",e);const n=this.WELCOME_TITLE,a=`${document.location.pathname}`+(""===t.toString()?"":"?")+`${t.toString()}`;history.pushState({data:"optional state object"},n,a),this.setDocumentTitle(n)}static itemsPerFlexRow(e){const t=Array.from(e.children),n={};return t.forEach(e=>{const t=e.offsetTop;n[t]||(n[t]=[]),n[t].push(e)}),Object.values(n).map(e=>e.length)}}const host="https://naslku.synology.me/gposesXplorerAPI/";async function handleInitialLoad(){Utilities.setIsNsfw(),Utilities.initMainParts(host),addNavigateSuccess(()=>Utilities.loadContent(host)),Utilities.loadContent(host)}function addNavigateSuccess(e){window.navigation?(window.navigation.removeEventListener("navigatesuccess",e),window.navigation.addEventListener("navigatesuccess",e)):(window._navigationFallback||(Object.defineProperty(window,"_navigationFallback",{value:{handlers:new Set,setup(){if(history.pushState._isMonkeyPatched)return;const e=history.pushState;history.pushState=function(...t){e.apply(this,t),window.document.title=t[1],window.dispatchEvent(new CustomEvent("fallbacknavigate",{detail:{url:window.location.href,state:t[0]}}))},history.pushState._isMonkeyPatched=!0,history.replaceState=function(...t){e.apply(this,t),window.document.title=t[1],window.dispatchEvent(new CustomEvent("fallbacknavigate",{detail:{url:window.location.href,state:t[0]}}))},history.replaceState._isMonkeyPatched=!0;const t=()=>{const e={destination:{url:window.location.href},state:history.state};window._navigationFallback.handlers.forEach(t=>t(e))};window.addEventListener("popstate",t),window.addEventListener("hashchange",t),window.addEventListener("fallbacknavigate",t)}},writable:!1,configurable:!1}),window._navigationFallback.setup()),window._navigationFallback.handlers.delete(e),window._navigationFallback.handlers.add(e))}document.addEventListener("DOMContentLoaded",()=>{handleInitialLoad()});